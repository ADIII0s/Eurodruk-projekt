@page "/user"
@inject ITicketService TicketService
@inject IUserTicketService UserTicketService

<h1>Panel użytkownika</h1>
<div class="grid-2" style="margin-top:16px">
    <section class="page-panel">
        <h2>Zgłoś usterkę</h2>
        <p class="empty-state" style="text-align:left;padding:0 0 10px">Podaj podstawowe informacje o usterce, aby serwis mógł szybciej ją obsłużyć.</p>
        <EditForm Model="form" OnValidSubmit="SubmitTicket" class="ticket-form">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <InputText @bind-Value="form.Title" placeholder="Tytuł zgłoszenia" />
            <div class="grid-2">
                <InputText @bind-Value="form.ErrorCode" placeholder="Kod błędu" />
                <InputText @bind-Value="form.MachineName" placeholder="Maszyna" />
            </div>
            <div class="grid-2">
                <InputText @bind-Value="form.ProductionLine" placeholder="Linia" />
                <div class="segment-field">
                    <label class="segment-label">Segment na maszynie</label>
                    <div class="segment-picker @(showSegmentMenu ? "open" : string.Empty)">
                        <button type="button" class="segment-trigger" @onclick="ToggleSegmentMenu">
                            <span>@(string.IsNullOrWhiteSpace(form.Location) ? "Wybierz segment" : form.Location)</span>
                            <span aria-hidden="true">▾</span>
                        </button>
                        <div class="segment-menu">
                            <button type="button" @onclick="() => SelectSegment(string.Empty)">Wyczyść wybór</button>
                            @foreach (var option in segmentOptions)
                            {
                                if (option.Variants.Any())
                                {
                                    <div class="segment-option has-sub" @onclick:stopPropagation="true">
                                        <span>@option.Label</span>
                                        <div class="segment-submenu">
                                            @foreach (var variant in option.Variants)
                                            {
                                                <button type="button" @onclick="() => SelectSegment($"{option.Label}, {variant.ToLower()}")">@variant</button>
                                            }
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <button class="segment-option" type="button" @onclick="() => SelectSegment(option.Label)">@option.Label</button>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
            <InputText @bind-Value="form.OperatorName" placeholder="Operator" />
            <InputTextArea @bind-Value="form.OperatorDescription" placeholder="Opis" />
            <div class="action-row">
                <button class="primary" type="submit">Zgłoś usterkę</button>
            </div>
        </EditForm>
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="toast">@successMessage</div>
        }
    </section>

    <section class="page-panel">
        <h2>Ostatnie zgłoszenia</h2>
        <div class="table-list">
            @if (recentTickets is null)
            {
                <p class="empty-state">Ładowanie…</p>
            }
            else if (!recentTickets.Any())
            {
                <p class="empty-state">Brak zgłoszeń.</p>
            }
            else
            {
                foreach (var ticket in recentTickets)
                {
                    <button class="ticket-card" @onclick="() => Select(ticket.Id)" style="text-align:left">
                        <div class="ticket-card__meta">@ticket.CreatedAt.ToLocalTime():dd.MM HH:mm • @ticket.MachineName • Linia @ticket.ProductionLine</div>
                        <strong>@ticket.Title</strong>
                        <p>@ticket.OperatorDescription</p>
                        <span class="status-pill @GetStatusClass(ticket.Status)">@ticket.Status</span>
                    </button>
                }
            }
        </div>
    </section>
</div>

@if (selectedTicket is not null)
{
    <div class="dialog-backdrop">
        <div class="dialog">
            <header>
                <h3>@selectedTicket.Title</h3>
                <button @onclick="() => selectedTicket = null">×</button>
            </header>
            <p><strong>Kod:</strong> @selectedTicket.ErrorCode</p>
            <p><strong>Opis:</strong> @selectedTicket.OperatorDescription</p>
            <p><strong>Status:</strong> @selectedTicket.Status</p>
            <p><strong>Serwis:</strong> @selectedTicket.ServiceDescription</p>
        </div>
    </div>
}

@code {
    private TicketForm form = new();
    private IReadOnlyList<WorkshopTicket>? recentTickets;
    private WorkshopTicket? selectedTicket;
    private string? successMessage;
    private bool showSegmentMenu;
    private readonly List<SegmentOption> segmentOptions = new()
    {
        new("Odwijak"),
        new("Zespół naprężający"),
        new("Agregat czarny", new[] { "Góra", "Dół" }),
        new("Agregat cyjan", new[] { "Góra", "Dół" }),
        new("Agregat magenta", new[] { "Góra", "Dół" }),
        new("Agregat żółty", new[] { "Góra", "Dół" }),
        new("UW"),
        new("Suszarka"),
        new("Chłodnik"),
        new("Sylikon"),
        new("Cięcie wstęgi"),
        new("Przerzutki i registry"),
        new("Klejownik"),
        new("Odcięcie głowa i nogi"),
        new("Odcięcie poprzeczne"),
        new("Zszywarka"),
        new("Rozdzielacz"),
        new("Wykładaki", new[] { "Góra", "Dół" })
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadTickets();
    }

    private async Task LoadTickets()
    {
        recentTickets = await UserTicketService.GetRecentAsync();
    }

    private void ToggleSegmentMenu()
    {
        showSegmentMenu = !showSegmentMenu;
    }

    private void SelectSegment(string value)
    {
        form.Location = value;
        showSegmentMenu = false;
    }

    private async Task SubmitTicket()
    {
        var input = new TicketInput(form.Title, form.ErrorCode, form.MachineName, form.ProductionLine, form.Location, form.OperatorName, form.OperatorDescription);
        await TicketService.CreateTicketAsync(input);
        form = new();
        successMessage = "Zgłoszenie zapisane";
        await LoadTickets();
    }

    private async Task Select(int id)
    {
        selectedTicket = await TicketService.GetTicketAsync(id);
    }

    private string GetStatusClass(TicketStatus status) => status switch
    {
        TicketStatus.Open => "status-open",
        TicketStatus.InProgress => "status-progress",
        TicketStatus.Closed => "status-closed",
        TicketStatus.Accepted => "status-closed",
        TicketStatus.Rejected => "status-rejected",
        _ => string.Empty
    };

    private sealed class TicketForm
    {
        [Required]
        public string Title { get; set; } = string.Empty;

        public string ErrorCode { get; set; } = string.Empty;

        [Required]
        public string MachineName { get; set; } = string.Empty;

        [Required]
        public string ProductionLine { get; set; } = string.Empty;

        [Required]
        public string Location { get; set; } = string.Empty;

        [Required]
        public string OperatorName { get; set; } = string.Empty;

        [Required]
        public string OperatorDescription { get; set; } = string.Empty;
    }

    private sealed record SegmentOption(string Label, IReadOnlyList<string> Variants)
    {
        public SegmentOption(string label) : this(label, Array.Empty<string>()) { }
    }
}
