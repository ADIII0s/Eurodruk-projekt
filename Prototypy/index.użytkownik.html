<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel użytkownika – fasada (pod Blazor)</title>
<style>
:root{
  --bg:#151a23; --panel:#1f2735; --panel-2:#181f2b;
  --muted:#c2ccd6; --text:#f3f7fd;
  --accent:#33c3ff; --accent-2:#7a7cff;
  --ok:#44e0a2; --warn:#ffb020;
  --radius:20px; --gap:16px;
  --shadow:0 14px 30px rgba(0,0,0,.38), 0 1px 0 rgba(255,255,255,.05) inset;
  --border:1px solid rgba(255,255,255,.12);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:linear-gradient(180deg,#0f131b 0%, var(--bg) 100%);
  color:var(--text);
  font:15px/1.55 system-ui,Segoe UI,Roboto,Ubuntu,Arial;
}

/* GRID */
.app{
  max-width:1550px; margin-inline:auto; padding:28px; display:grid;
  grid-template-columns:1fr 1.25fr 1fr; gap:24px;
}
@media (max-width:1200px){.app{grid-template-columns:1fr}}

.panel{
  background: radial-gradient(120% 120% at 0% 0%, #1a2130 0%, var(--panel) 45%, var(--panel-2) 100%);
  border:var(--border); border-radius:calc(var(--radius) + 8px); box-shadow:var(--shadow); padding:24px;
}
.panel h2{margin:0 0 12px; font-size:15px; font-weight:600; color:#dce6f2}

/* LISTA */
.left{display:flex; flex-direction:column; min-height:640px}
.list{
  height:360px; overflow:auto; display:flex; flex-direction:column; gap:10px; padding:8px;
  border-radius:var(--radius); background:rgba(0,0,0,.15); border:var(--border);
}
.item{
  display:grid; grid-template-columns:auto 90px; gap:10px; align-items:center;
  padding:12px 14px; border-radius:12px; background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06); cursor:pointer;
}
.item:hover{outline:1px solid rgba(51,195,255,.25); background:rgba(255,255,255,.05)}
.item.active{outline:1px solid rgba(51,195,255,.45); background:rgba(51,195,255,.06)}
.item .title{font-weight:600}
.item .meta{color:var(--muted); font-size:12px}
.badge{font-size:12px; padding:4px 10px; border-radius:999px; text-align:center}
.badge.ok{background:rgba(61,220,151,.18); color:#a3f3d3; border:1px solid rgba(61,220,151,.35)}
.badge.open{background:rgba(255,176,32,.15); color:#ffd18a; border:1px solid rgba(255,176,32,.35)}
.badge.progress{background:rgba(122,124,255,.18); color:#cdd1ff; border:1px solid rgba(122,124,255,.35)}
.empty{color:var(--muted); padding:6px 4px}

/* TOOLBAR/FILTRY */
.filters-wrap{margin-top:16px}
.toolbar-row{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
.btn{
  padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06); color:var(--text); cursor:pointer; user-select:none;
  font-size:13px;
}
.btn:hover{background:rgba(255,255,255,.12)}
.btn.toggle.active{
  background:linear-gradient(90deg, rgba(51,195,255,.22), rgba(122,124,255,.22));
  border-color:rgba(51,195,255,.35);
}
.btn.accent{border-color:rgba(51,195,255,.35); background:rgba(51,195,255,.12)}
.btn.ghost{background:transparent}

.filters{
  display:grid; grid-template-columns:repeat(2,1fr); gap:10px;
  padding:12px; border-radius:14px; border:var(--border); background:rgba(255,255,255,.03);
}
.filters label{display:grid; gap:6px; font-size:13px; color:var(--muted)}
.filters input{
  padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.22);
  background:rgba(255,255,255,.04); color:var(--text)
}
.filter-actions{grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end}

/* Segment picker (JS) */
.segment-picker{position:relative}
.segment-trigger{
  width:100%; text-align:left; border-radius:14px; padding:12px;
  border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.04); color:var(--text);
  display:flex; justify-content:space-between; align-items:center; cursor:pointer;
}
.segment-menu{
  position:absolute; left:0; right:0; top:calc(100% + 6px);
  background:var(--panel); border:var(--border); border-radius:16px; box-shadow:var(--shadow);
  padding:8px; display:none; z-index:50; max-height:360px; overflow:auto;
}
.segment-picker.open .segment-menu{display:grid; gap:6px}

.seg-btn{
  width:100%; text-align:left; border:none; padding:10px 12px; border-radius:12px;
  background:rgba(255,255,255,.04); color:var(--text); cursor:pointer;
}
.seg-btn:hover{background:rgba(255,255,255,.08)}
.seg-btn.has-sub{position:relative; padding-right:90px}
.seg-submenu{
  position:absolute; right:8px; top:50%; transform:translateY(-50%);
  display:none; gap:6px;
}
.seg-btn.has-sub:hover .seg-submenu{display:flex}
.seg-submenu button{
  width:auto; padding:8px 10px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08); color:var(--text);
  border-radius:10px; cursor:pointer;
}

/* DETAILS */
.details{display:grid; grid-template-rows:auto auto auto auto; gap:16px; min-height:640px}
.place{
  padding:14px 16px; border-radius:14px; background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06); font-weight:600;
}

.header-row{
  display:grid;
  grid-template-columns:minmax(0,1fr) 360px;
  gap:24px;
  align-items:start;
}
@media (max-width:1200px){ .header-row{grid-template-columns:1fr} }

.tabs{display:grid; gap:10px; position:relative}
.tabs>input{position:absolute; opacity:0; pointer-events:none}
.tab-head{
  display:flex; gap:8px; flex-wrap:wrap;
  background:rgba(255,255,255,.03); padding:6px;
  border-radius:999px; border:1px solid rgba(255,255,255,.06)
}
.tab-head label{
  cursor:pointer; padding:6px 12px; border-radius:999px; color:var(--muted); font-size:13px;
}
#t1:checked ~ .tab-head label[for="t1"],
#t2:checked ~ .tab-head label[for="t2"]{
  color:var(--text);
  background:linear-gradient(90deg, rgba(51,195,255,.22), rgba(122,124,255,.22));
  outline:1px solid rgba(51,195,255,.35)
}
.tab-panel{
  display:none; height:260px; overflow:auto; padding:14px 16px;
  border-radius:14px; border:1px solid rgba(255,255,255,.06);
  background:rgba(255,255,255,.03);
}
#t1:checked ~ .tab-body #p1{display:block}
#t2:checked ~ .tab-body #p2{display:block}

.photo-strip{
  display:grid; gap:10px;
  grid-auto-flow:column;
  grid-auto-columns:minmax(180px,1fr);
  height:320px;
  overflow:auto;
  scroll-snap-type:x mandatory;
  padding:8px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.06);
  background:rgba(255,255,255,.03);
}
.photo{
  border-radius:12px;
  border:1px solid rgba(255,255,255,.07);
  scroll-snap-align:center;
  overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  color:var(--muted); position:relative; cursor:pointer;
}
.photo img{width:100%; height:100%; object-fit:cover; display:block}

/* Actions */
.actions-row{
  margin-top:4px;
  padding:14px 22px;
  border-radius:32px;
  border:var(--border);
  background:rgba(0,0,0,.25);
  display:flex;
  justify-content:center;
  gap:24px;
  flex-wrap:wrap;
}
.action-btn{
  min-width:200px;
  padding:12px 22px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.04);
  color:var(--text);
  font-size:14px;
  cursor:pointer;
}
.action-btn.primary{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  border:none;
  color:#0f1216;
  font-weight:700;
}
.action-btn:hover{filter:brightness(1.05)}

/* RIGHT */
.right{display:flex; flex-direction:column; min-height:640px}
.right .list{flex:1}
.right .actions-fixed{margin-top:auto; display:flex}
.right .gen-btn{
  padding:10px 14px; border-radius:10px; border:1px solid rgba(122,124,255,.35);
  background:rgba(122,124,255,.12); color:var(--text); cursor:pointer;
}
.right .gen-btn:disabled{opacity:.5; cursor:not-allowed}

/* Lightbox */
.lightbox{
  position:fixed; inset:0; background:rgba(0,0,0,.9);
  display:none; align-items:center; justify-content:center; z-index:9999;
}
.lightbox.open{display:flex}
.lightbox img{max-width:min(92vw,1600px); max-height:92vh; border-radius:12px}
.lightbox .close{
  position:absolute; top:16px; right:16px; background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.25); color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
}
</style>
</head>
<body>

<main class="app">
  <!-- LEWA -->
  <section class="panel left">
    <h2>Baza awarii</h2>
    <div class="list" id="allList"></div>

    <div class="filters-wrap">
      <div class="toolbar-row">
        <button class="btn toggle" id="sortBtn">Sortuj ↓ data</button>
        <button class="btn toggle" data-machine="KBA">KBA</button>
        <button class="btn toggle" data-machine="DUR">DUR</button>
        <button class="btn toggle" data-line="L2">L2</button>
        <button class="btn toggle" data-line="L3">L3</button>
        <button class="btn toggle" data-line="INTRO">INTRO</button>
      </div>

      <div class="filters">
        <label><span>Data od</span><input type="date" id="fFrom"></label>
        <label><span>Data do</span><input type="date" id="fTo"></label>

        <label><span>Miejsce / segment</span>
          <div class="segment-picker" data-input="fPlace">
            <button type="button" class="segment-trigger">
              <span>Wybierz segment</span><span aria-hidden="true">▾</span>
            </button>
            <div class="segment-menu" id="segmentMenu"></div>
          </div>
          <input type="hidden" id="fPlace">
        </label>

        <label><span>Kod błędu</span><input type="text" id="fErr" placeholder="np. E42"></label>
        <label style="grid-column:1/-1"><span>Fragment opisu</span><input type="text" id="fText" placeholder="szukaj w treści"></label>

        <div class="filter-actions">
          <button class="btn accent" id="applyBtn">Szukaj</button>
          <button class="btn ghost" id="clearBtn">Wyczyść</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ŚRODEK -->
  <section class="panel details">
    <h2>Szczegóły zgłoszenia</h2>
    <div id="place" class="place">Wybierz zgłoszenie z listy po lewej.</div>

    <div class="header-row">
      <div class="tabs">
        <input type="radio" id="t1" name="tabs" checked>
        <input type="radio" id="t2" name="tabs">

        <div class="tab-head">
          <label for="t1">Opis operatora</label>
          <label for="t2">Co zrobił serwisant</label>
        </div>

        <div class="tab-body">
          <div id="p1" class="tab-panel"></div>
          <div id="p2" class="tab-panel"></div>
        </div>
      </div>

      <aside id="photos" class="photo-strip" aria-label="Zdjęcia"></aside>
    </div>

    <div class="actions-row">
      <button class="action-btn primary" id="addBtn" disabled>Dodaj do raportu</button>
      <button class="action-btn" id="startBtn" disabled>Rozpocznij pracę</button>
      <button class="action-btn" id="closeBtn" disabled>Zamknij zgłoszenie</button>
    </div>
  </section>

  <!-- PRAWA -->
  <section class="panel right">
    <h2>Wybrane do raportu</h2>
    <div class="list" id="pickedList"><div class="empty">Brak pozycji</div></div>
    <div class="actions-fixed">
      <button class="gen-btn" id="genBtn" disabled>Generuj raport</button>
    </div>
  </section>
</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Podgląd zdjęcia">
  <button class="close" id="lbClose" aria-label="Zamknij">Zamknij</button>
  <img id="lbImg" alt="">
</div>

<script>
/* ====== 1) Segmenty (Twoja lista + podlisty) ====== */
const SEGMENTS = [
  { label: "Wyczyść wybór", value: "" },

  { label: "Odwijak", sub: [
    { label: "Ramię A", value: "Odwijak → Ramię A" },
    { label: "Ramię B", value: "Odwijak → Ramię B" },
  ]},

  { label: "Zespół naprężający", value: "Zespół naprężający" },

  { label: "Agregat farbowy czarny", sub: [
    { label: "Góra", value: "Agregat farbowy czarny → Góra" },
    { label: "Dół", value: "Agregat farbowy czarny → Dół" },
  ]},
  { label: "Agregat farbowy Cyjan", sub: [
    { label: "Góra", value: "Agregat farbowy Cyjan → Góra" },
    { label: "Dół", value: "Agregat farbowy Cyjan → Dół" },
  ]},
  { label: "Agregat farbowy Magenta", sub: [
    { label: "Góra", value: "Agregat farbowy Magenta → Góra" },
    { label: "Dół", value: "Agregat farbowy Magenta → Dół" },
  ]},
  { label: "Agregat farbowy Żółty", sub: [
    { label: "Góra", value: "Agregat farbowy Żółty → Góra" },
    { label: "Dół", value: "Agregat farbowy Żółty → Dół" },
  ]},

  { label: "Urządzenie wychwytujące", value: "Urządzenie wychwytujące" },

  { label: "Suszarka", sub: [
    { label: "Sekcja 1", value: "Suszarka → Sekcja 1" },
    { label: "Sekcja 2", value: "Suszarka → Sekcja 2" },
    { label: "Sekcja 3", value: "Suszarka → Sekcja 3" },
    { label: "Sekcja 4", value: "Suszarka → Sekcja 4" },
    { label: "Ogólna usterka pieca", value: "Suszarka → Ogólna usterka pieca" },
  ]},

  { label: "Chłodnik", value: "Chłodnik" },
  { label: "Sylikon", value: "Sylikon" },
  { label: "Nadbudowa", value: "Nadbudowa" },
  { label: "Klejownik", value: "Klejownik" },

  { label: "Noże", sub: [
    { label: "Głowa", value: "Noże → Głowa" },
    { label: "Nogi", value: "Noże → Nogi" },
  ]},

  { label: "Nóż poprzeczny", value: "Nóż poprzeczny" },
  { label: "Falcownik", value: "Falcownik" },
  { label: "Zszywarka", value: "Zszywarka" },
  { label: "Rozdzielacz", value: "Rozdzielacz" },
  { label: "3 łam", value: "3 łam" },
  { label: "Wykładaki", value: "Wykładaki" },

  { label: "Linie góra", sub: [
    { label: "Transport", value: "Linie góra → Transport" },
    { label: "Noże", value: "Linie góra → Noże" },
    { label: "Gemmeler", value: "Linie góra → Gemmeler" },
  ]},
  { label: "Linie dół", sub: [
    { label: "Transport", value: "Linie dół → Transport" },
    { label: "Noże", value: "Linie dół → Noże" },
    { label: "Gemmeler", value: "Linie dół → Gemmeler" },
  ]},
];

/* ====== 2) Dane mock (do podglądu UI) ====== */
const ALL = [
  {
    id: 1,
    title: "KBA Compacta 818 — sekcja 3 — błąd E42",
    meta: "Zgłoszono: 2025-01-05 12:04 | Operator: J.D.",
    status: "open",
    place: "KBA C818 → Sekcja 3 → Kod: E42",
    machine: "KBA", line: "L3", error: "E42", date: "2025-01-05",
    op: "Podczas startu sekcji 3 pojawia się błąd E42. Maszyna nie pobiera wstęgi z odwijaka. Po skasowaniu błąd wraca natychmiast.",
    svc: "Wymieniono czujnik prędkości. Dokręcono rolkę prowadzącą, nasmarowano łożyska. Test 30 min OK.",
    photos: [
      "https://picsum.photos/1000/700?random=11",
      "https://picsum.photos/1000/700?random=12",
      "https://picsum.photos/1000/700?random=13"
    ]
  },
  {
    id: 2,
    title: "Roland Lithoman IV — odwijak A — czujnik taśmy",
    meta: "Zgłoszono: 2025-01-04 10:31 | Operator: A.K.",
    status: "progress",
    place: "Roland Lithoman IV → Odwijak A → Czujnik taśmy",
    machine: "KBA", line: "L2", error: "E07", date: "2025-01-04",
    op: "W trakcie biegu maszyny czujnik taśmy gubi impuls. Pasek zatrzymuje się.",
    svc: "W toku: weryfikacja wiązki i czujnika.",
    photos: ["https://picsum.photos/1000/700?random=21"]
  },
  {
    id: 3,
    title: "DUR — kompresor Atlas — wymiana filtra oleju",
    meta: "Zamknięto: 2025-01-03 09:12 | Serwis: M.S.",
    status: "ok",
    place: "Kompresor Atlas → Filtr oleju",
    machine: "DUR", line: "L2", error: "", date: "2025-01-03",
    op: "Wzrost temperatury o 15°C. Filtr zatarasowany.",
    svc: "Wymieniono filtr, uruchomiono, temp. w normie.",
    photos: []
  }
];

/* ====== 3) Stan (łatwo przeniesiesz na Blazor) ====== */
const state = {
  selectedId: null,
  pickedIds: [],
  filters: {
    from: null, to: null,
    place: "", text: "", err: "",
    machine: new Set(),
    line: new Set(),
    sortDesc: true
  }
};

/* ====== 4) Elementy DOM ====== */
const $allList = document.getElementById('allList');
const $pickedList = document.getElementById('pickedList');
const $place = document.getElementById('place');
const $p1 = document.getElementById('p1');
const $p2 = document.getElementById('p2');
const $photos = document.getElementById('photos');
const $addBtn = document.getElementById('addBtn');
const $startBtn = document.getElementById('startBtn');
const $closeBtn = document.getElementById('closeBtn');
const $genBtn = document.getElementById('genBtn');

/* ====== 5) Segment picker render + obsługa ====== */
function buildSegmentMenu(menuEl){
  menuEl.innerHTML = '';

  SEGMENTS.forEach(seg=>{
    if(seg.sub && Array.isArray(seg.sub)){
      const wrap = document.createElement('div');
      wrap.className = 'seg-btn has-sub';
      wrap.innerHTML = `<span>${seg.label}</span><div class="seg-submenu"></div>`;
      const sub = wrap.querySelector('.seg-submenu');

      seg.sub.forEach(s=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = s.label;
        b.addEventListener('click', (e)=>{
          e.stopPropagation();
          pickSegment(menuEl.closest('.segment-picker'), s.value);
        });
        sub.appendChild(b);
      });

      // klik w rodzica nic nie wybiera (tylko rozwijka pod)
      wrap.addEventListener('click', (e)=>e.stopPropagation());
      menuEl.appendChild(wrap);
    } else {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'seg-btn';
      b.textContent = seg.label;
      b.addEventListener('click', (e)=>{
        e.stopPropagation();
        pickSegment(menuEl.closest('.segment-picker'), seg.value ?? '');
      });
      menuEl.appendChild(b);
    }
  });
}

function pickSegment(pickerEl, value){
  const inputId = pickerEl.dataset.input;
  const hidden = document.getElementById(inputId);
  const labelSpan = pickerEl.querySelector('.segment-trigger span');
  if(hidden) hidden.value = value;
  if(labelSpan) labelSpan.textContent = value || 'Wybierz segment';
  pickerEl.classList.remove('open');
}

function initSegmentPickers(){
  document.querySelectorAll('.segment-picker').forEach(picker=>{
    const trigger = picker.querySelector('.segment-trigger');
    const menu = picker.querySelector('.segment-menu');
    if(menu && menu.id === 'segmentMenu') buildSegmentMenu(menu);

    trigger.addEventListener('click', ()=>picker.classList.toggle('open'));
  });

  document.addEventListener('click', (e)=>{
    document.querySelectorAll('.segment-picker.open').forEach(p=>{
      if(!p.contains(e.target)) p.classList.remove('open');
    });
  });
}
initSegmentPickers();

/* ====== 6) Filtry, render listy ====== */
function applyFilters(arr){
  let q = [...arr];

  // sort: otwarte/progress wyżej, potem data desc
  q.sort((a,b)=>{
    const pri = s => (s === 'ok' ? 2 : (s === 'progress' ? 1 : 0));
    const d = pri(a.status) - pri(b.status);
    if(d !== 0) return d;
    const da = new Date(a.date || "1970-01-01");
    const db = new Date(b.date || "1970-01-01");
    return state.filters.sortDesc ? (db - da) : (da - db);
  });

  const F = state.filters;
  if(F.machine.size) q = q.filter(t => F.machine.has(t.machine));
  if(F.line.size)    q = q.filter(t => F.line.has(t.line));
  if(F.from)         q = q.filter(t => new Date(t.date) >= new Date(F.from));
  if(F.to)           q = q.filter(t => new Date(t.date) <= new Date(F.to));
  if(F.place)        q = q.filter(t => (t.place||"").toLowerCase().includes(F.place.toLowerCase()));
  if(F.err)          q = q.filter(t => (t.error||"").toLowerCase().includes(F.err.toLowerCase()));
  if(F.text)         q = q.filter(t => ((t.op||"")+(t.svc||"")).toLowerCase().includes(F.text.toLowerCase()));

  return q;
}

function statusBadgeClass(s){
  if(s === 'ok') return 'ok';
  if(s === 'progress') return 'progress';
  return 'open';
}
function statusLabel(s){
  if(s === 'ok') return 'zamknięte';
  if(s === 'progress') return 'w toku';
  return 'otwarte';
}

function renderList(){
  const data = applyFilters(ALL);
  $allList.innerHTML = '';

  if(!data.length){
    $allList.innerHTML = '<div class="empty">Brak zgłoszeń dla wybranych filtrów.</div>';
    state.selectedId = null;
    renderDetails(null);
    return;
  }

  data.forEach((t, i)=>{
    const el = document.createElement('article');
    el.className = 'item' + (t.id === state.selectedId ? ' active' : '');
    el.dataset.id = t.id;

    el.innerHTML = `
      <div>
        <div class="title">${t.title}</div>
        <div class="meta">${t.meta}</div>
      </div>
      <div><span class="badge ${statusBadgeClass(t.status)}">${statusLabel(t.status)}</span></div>
    `;

    el.addEventListener('click', ()=>selectTicket(t.id));
    $allList.appendChild(el);

    if(i === 0 && state.selectedId == null) selectTicket(t.id);
  });

  // jeśli wybrane nie istnieje po filtrach, ustaw pierwsze
  if(state.selectedId != null && !data.some(x=>x.id === state.selectedId)){
    selectTicket(data[0].id);
  }
}

function selectTicket(id){
  state.selectedId = id;
  [...$allList.children].forEach(n=>{
    const nid = Number(n.dataset.id);
    n.classList.toggle('active', nid === id);
  });
  const t = ALL.find(x=>x.id === id) || null;
  renderDetails(t);
}

function renderDetails(t){
  if(!t){
    $place.textContent = 'Wybierz zgłoszenie z listy po lewej.';
    $p1.innerHTML = '';
    $p2.innerHTML = '';
    $photos.innerHTML = '<div class="photo">Brak zdjęć</div>';
    $addBtn.disabled = true;
    $startBtn.disabled = true;
    $closeBtn.disabled = true;
    return;
  }

  $place.textContent = "Miejsce: " + t.place;
  $p1.innerHTML = t.op || '';
  $p2.innerHTML = t.svc || '';

  $photos.innerHTML = '';
  if(!t.photos || t.photos.length === 0){
    $photos.innerHTML = '<div class="photo">Brak zdjęć</div>';
  }else{
    t.photos.forEach(src=>{
      const fig = document.createElement('figure');
      fig.className = 'photo';
      fig.innerHTML = `<img src="${src}" alt="">`;
      fig.addEventListener('click', ()=>openLightbox(src));
      $photos.appendChild(fig);
    });
  }

  $addBtn.disabled = false;
  $startBtn.disabled = false;
  $closeBtn.disabled = (t.status === 'ok'); // zamknięte = brak sensu
}

/* ====== 7) Wybrane do raportu ====== */
function renderPicked(){
  const picked = state.pickedIds.map(id=>ALL.find(x=>x.id===id)).filter(Boolean);

  $pickedList.innerHTML = '';
  if(!picked.length){
    $pickedList.innerHTML = '<div class="empty">Brak pozycji</div>';
    $genBtn.disabled = true;
    return;
  }

  picked.forEach(t=>{
    const el = document.createElement('article');
    el.className = 'item';
    el.innerHTML = `
      <div>
        <div class="title">${t.title}</div>
        <div class="meta">${t.meta}</div>
      </div>
      <div><button class="btn" type="button" style="padding:6px 10px">usuń</button></div>
    `;
    el.querySelector('button').addEventListener('click', ()=>{
      state.pickedIds = state.pickedIds.filter(x=>x !== t.id);
      renderPicked();
    });
    $pickedList.appendChild(el);
  });

  $genBtn.disabled = false;
}

/* ====== 8) Akcje ====== */
$addBtn.addEventListener('click', ()=>{
  const id = state.selectedId;
  if(id == null) return;
  if(!state.pickedIds.includes(id)) state.pickedIds.push(id);
  renderPicked();
});

$startBtn.addEventListener('click', ()=>{
  const t = ALL.find(x=>x.id===state.selectedId);
  if(!t) return;
  alert("FAKE: Rozpoczęto pracę nad: " + t.title);
});

$closeBtn.addEventListener('click', ()=>{
  const t = ALL.find(x=>x.id===state.selectedId);
  if(!t) return;
  if(t.status === 'ok') return;
  // fasada: zmiana statusu + dopisek
  t.status = 'ok';
  t.meta = "Zamknięto: 2025-01-06 14:20 | Serwis: (demo)";
  t.svc = (t.svc || '') + "<br><br><b>[demo]</b> Zgłoszenie zamknięte.";
  renderList();
  renderDetails(t);
});

$genBtn.addEventListener('click', ()=>{
  alert("FAKE: Wygenerowano raport z " + state.pickedIds.length + " pozycji.");
});

/* ====== 9) Filtry UI ====== */
function toggleBtn(btn, group){
  btn.classList.toggle('active');
  const val = btn.dataset[group];
  if(!val) return;
  const set = state.filters[group];
  if(btn.classList.contains('active')) set.add(val); else set.delete(val);
  renderList();
}
document.querySelectorAll('[data-machine]').forEach(b=> b.addEventListener('click', ()=>toggleBtn(b,'machine')));
document.querySelectorAll('[data-line]').forEach(b=> b.addEventListener('click', ()=>toggleBtn(b,'line')));

document.getElementById('sortBtn').addEventListener('click', ()=>{
  state.filters.sortDesc = !state.filters.sortDesc;
  document.getElementById('sortBtn').textContent = state.filters.sortDesc ? "Sortuj ↓ data" : "Sortuj ↑ data";
  renderList();
});

document.getElementById('applyBtn').addEventListener('click', ()=>{
  state.filters.from  = document.getElementById('fFrom').value || null;
  state.filters.to    = document.getElementById('fTo').value || null;
  state.filters.place = document.getElementById('fPlace').value || '';
  state.filters.err   = document.getElementById('fErr').value || '';
  state.filters.text  = document.getElementById('fText').value || '';
  renderList();
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  ['fFrom','fTo','fPlace','fErr','fText'].forEach(id=>document.getElementById(id).value='');
  state.filters.from = state.filters.to = null;
  state.filters.place = state.filters.err = state.filters.text = "";
  state.filters.machine.clear();
  state.filters.line.clear();
  document.querySelectorAll('.btn.toggle.active').forEach(b=>b.classList.remove('active'));

  // reset label w pickerze
  document.querySelectorAll('.segment-picker').forEach(p=>{
    const labelSpan = p.querySelector('.segment-trigger span');
    if(labelSpan) labelSpan.textContent = 'Wybierz segment';
    p.classList.remove('open');
  });

  renderList();
});

/* ====== 10) Lightbox ====== */
const $lb = document.getElementById('lightbox');
const $lbImg = document.getElementById('lbImg');
document.getElementById('lbClose').addEventListener('click', closeLightbox);
$lb.addEventListener('click', e=>{ if(e.target === $lb) closeLightbox(); });
document.addEventListener('keydown', e=>{ if(e.key === 'Escape') closeLightbox(); });

function openLightbox(src){
  $lbImg.src = src;
  $lb.classList.add('open');
}
function closeLightbox(){
  $lb.classList.remove('open');
  $lbImg.src = '';
}

/* ====== Start ====== */
renderList();
renderPicked();
</script>
</body>
</html>
